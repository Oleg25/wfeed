<?phperror_reporting(E_ALL);//require_once ("simple_html_dom.php");//header('Content-Type: text/xml');define("feedUrl","http://www.gismeteo.ru/ajax/print/14528/short/");//Не ООП а императивный подход	function get_cont() {		try {			$curl = curl_init();			curl_setopt($curl, CURLOPT_HEADER, false);			curl_setopt($curl, CURLOPT_URL, feedUrl);			curl_setopt($curl, CURLOPT_TIMEOUT, 3);			curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);			curl_setopt($curl, CURLOPT_REFERER, "http://www.gismeteo.ru");					$feedContent = curl_exec($curl);						curl_close($curl);						}					catch (Exception $e){ echo 'Ошибка грабера: ', $e->getMessage(), "\n"; }						return $feedContent;						}												$v1 = get_cont();						if (preg_match('|<table.*?>(.*)</table>|sei', $v1, $arr)) $table = $arr[1];						else $table='';												//echo "<table border='1'>".$table."</table>";                // без стороннего класса(например simple_html_dom.php) используем нативный DOMDocoment                			    $table2 = mb_convert_encoding($table, 'html-entities', 'utf-8');				$dom = new DOMDocument();				$dom->loadHTML($table2);				$dom->preserveWhiteSpace = false;//для правильной индексации тексовых узлов с пробелами																											$xpath = new DOMXPath($dom);								$t_sky = $xpath->query('//tr[3]/td[4]/div/img');				$sky_today = substr($t_sky->item(0)->getAttribute('src'),59);											$t_temp_af = $xpath->query('//tr[4]/td[4]')->item(0)->nodeValue;																 $nodeList = $xpath->query('//tr/td[9]');//скалярная переменная содержит колекцию DOMNodeList погода на завтра				 				 $nodeList2 = $xpath->query('//tr/td[14]');//скалярная переменная содержит колекцию DOMNodeList погода на после завтра				 								               				  				   foreach ($nodeList as $node){ //завтра				    					$nodes[] = $node->childNodes->item(0)->nodeValue;				        }										   $sky_d1 = substr($nodeList->item(0)->getElementsByTagName('img')->item(0)->getAttribute('src'),59);					   $temp_d1 = $nodes[1];				   $temp_d1_mon = $xpath->query('//tr[4]/td[8]')->item(0)->nodeValue;				   $wind_d1 = $nodes[2];				   				   				  foreach ($nodeList2 as $node2){ //после завтра				    					$nodes2[] = $node2->childNodes->item(0)->nodeValue;				        }										   $sky_d2 = substr($nodeList2->item(0)->getElementsByTagName('img')->item(0)->getAttribute('src'),59);				   				   $temp_d2_mon = $xpath->query('//tr[4]/td[13]')->item(0)->nodeValue;				   $temp_d2 = $nodes2[1];				  				   $wind_d2 = $nodes2[2];                  								   				   				   //echo $temp_d1."<br />".$sky_d1."<br />".$temp_d1_mon."<br />".$sky_today;				  	 				                   // а вот тут подобие конечного автомата			  		switch ($sky_today){				        case 'sun.c2.st.png':						$sky_today = 'Storm';												break;						case 'sun.c2.r1.png':						$sky_today = 'Rain';												break;						case 'sun.c2.png':						$sky_today = 'Partly_cloudly';												break;						case 'sun.c4.png':						$sky_today = 'Cloudly';												break;						case 'sun.png':						$sky_today = 'Sun';												break;						case 'sun.c3.png':						$sky_today = 'Sun';												break;						default: $sky_today = $sky_today;					}		  		  				switch ($sky_d1){				        case 'sun.c2.st.png':						$sky_d1 = 'Storm';												break;								        case 'sun.c2.r1.png':						$sky_d1 = 'Rain';												break;						case 'sun.c2.png':						$sky_d1 = 'Partly_cloudly';												break;						case 'sun.c4.png':						$sky_d1 = 'Cloudly';												break;						case 'sun.png':						$sky_d1 = 'Sun';												break;						case 'sun.c3.png':						$sky_d1 = 'Sun';												break;						default: $sky_d1 = $sky_d1;					}																									//Облачность послезавтра										switch ($sky_d2){					    case 'sun.c2.st.png':						$sky_d2 = 'Storm';												break;				        case 'sun.c2.r1.png':						$sky_d2 = 'Rain';												break;						case 'sun.c2.png':						$sky_d2 = 'Partly_cloudly';												break;						case 'sun.c4.png':						$sky_d2 = 'Cloudly';												break;						case 'sun.png':						$sky_d2 = 'Sun';												break;					    case 'sun.c3.png':						$sky_d2 = 'Sun';												break;						default: $sky_d2 = $sky_d2;					}																	 	  				   						      $data_send_d1 ="<station name='Rosa 1600'> <sky_today>$sky_today</sky_today> <temp_af>$t_temp_af</temp_af>	<time period='d1'>				<temperature value='$temp_d1_mon' />		<symbol name='$sky_d1' />		<windSpeed mps='$wind_d1' />			 </time>	 	 	 <time><temperature value='$temp_d1' /></time>	 	 <time/><time/>	 	 <time period='d2'>					<temperature value='$temp_d2_mon' />		<symbol name='$sky_d2' />		<windSpeed mps='$wind_d2' />			 </time>	 <time><temperature value='$temp_d2' /></time>	  </station>";	  	  	  		//echo  $data_send_d1;	  							       function sanitize($vars){ @$vars= htmlentities($vars); return @$vars; }					         //готовим REST API (ну почти :))		if (isset($_GET['grab_gismeteo'])) {			$v1 = sanitize($_GET['grab_gismeteo']);			   if( $v1 == 'd1'){				if ($_SERVER['SERVER_PROTOCOL'] == 'HTTP/1.1'){					header('HTTP/1.1 200 OK');					header('Content-Type: application/xml; charset=utf-8');					print $data_send_d1; unset($data_send_d1);} else {					header('HTTP/1.0 200 OK');					header('Content-Type: application/xml; charset=utf-8');					print $data_send_d1;					unset($data_send_d1);					     } }			} 	  ?>