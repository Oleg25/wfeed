<?phperror_reporting(E_ALL);//require_once ("simple_html_dom.php");//header('Content-Type: text/xml');define("feedUrl","http://www.gismeteo.ru/ajax/print/14528/short/");  function clear_w($str){   return preg_replace('/[\+\s]*/', '', $str);     }   function replace($path){						 $search = array ("'С'", "'Ю'", "'З'", "'В'","'C'");						 $replace= array ("N", "S", "W", "E","N" );						 return preg_replace ($search,$replace,$path);						}	function get_cont() {		try {			$curl = curl_init();			curl_setopt($curl, CURLOPT_HEADER, false);			curl_setopt($curl, CURLOPT_URL, feedUrl);						curl_setopt($curl, CURLOPT_TIMEOUT, 3);			curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);			curl_setopt($curl, CURLOPT_REFERER, "http://www.gismeteo.ru");					$feedContent = curl_exec($curl);						curl_close($curl);						}					catch (Exception $e){ echo 'Ошибка грабера: ', $e->getMessage(), "\n"; }						return $feedContent;						}						$v1 = get_cont();						if (preg_match('|<table.*?>(.*)</table>|si', $v1, $arr)) $table = $arr[1];						else $table='error';						//echo "<table border='1'>".$table."</table>";                // без стороннего класса(например simple_html_dom.php) используем нативный DOMDocoment			    $table2 = mb_convert_encoding($table, 'html-entities', 'utf-8');				$dom = new DOMDocument();				$dom->loadHTML($table2);				$dom->preserveWhiteSpace = false;//для правильной индексации тексовых узлов с пробелами				$xpath = new DOMXPath($dom);				$t_sky = $xpath->query('//tr[3]/td[4]/div/img');				$sky_today = substr($t_sky->item(0)->getAttribute('src'),59);								$t_temp_af = clear_w($xpath->query('//tr[4]/td[4]')->item(0)->nodeValue);												$wind_d1 = clear_w($xpath->query('//tr[5]/td[9]/div[1]')->item(0)->nodeValue);				$wind_dir_d1 = clear_w(replace($xpath->query('//tr[5]/td[9]/div[2]/span')->item(0)->nodeValue));								$wind_d2 = clear_w($xpath->query('//tr[5]/td[14]/div[1]')->item(0)->nodeValue);				$wind_dir_d2 = clear_w(replace($xpath->query('//tr[5]/td[14]/div[2]/span')->item(0)->nodeValue));								//echo $wind_d1."<br />".$wind_dir_d1." d2 ".$wind_d2."<br />".$wind_dir_d2;				 $nodeList = $xpath->query('//tr/td[9]');//скалярная переменная содержит колекцию DOMNodeList погода на завтра				 $nodeList2 = $xpath->query('//tr/td[14]');//скалярная переменная содержит колекцию DOMNodeList погода на после завтра				   foreach ($nodeList as $node){ //завтра					$nodes[] = $node->childNodes->item(0)->nodeValue;				        }				   $sky_d1 = substr($nodeList->item(0)->getElementsByTagName('img')->item(0)->getAttribute('src'),59);				   $temp_d1 = clear_w($nodes[1]);				   				   $temp_d1_mon = clear_w($xpath->query('//tr[4]/td[8]')->item(0)->nodeValue);				   				  foreach ($nodeList2 as $node2){ //после завтра					$nodes2[] = $node2->childNodes->item(0)->nodeValue;				        }				   $sky_d2 = substr($nodeList2->item(0)->getElementsByTagName('img')->item(0)->getAttribute('src'),59);				   $temp_d2_mon = clear_w($xpath->query('//tr[4]/td[13]')->item(0)->nodeValue);				   $temp_d2 = clear_w($nodes2[1]);				                   // а вот тут подобие конечного автомата		  		switch ($sky_today){				        case 'sun.c2.st.png':						$sky_today = 'STORM';						$sky_id = '6';						break;						case 'sun.c2.r1.png':						$sky_today = 'RAIN';						$sky_id = '6';						break;						case 'sun.c2.png':						$sky_today = 'PARTLY SUNNY';						$sky_id = '2';						break;						case 'sun.c4.png':						$sky_today = 'CLOUDY';						$sky_id = '3';						break;						case 'sun.png':						$sky_today = 'SUNNY';						$sky_id = '1';						break;						case 'sun.c3.png':						$sky_today = 'SUNNY';						$sky_id = '1';						break;						default: $sky_today = $sky_today;					}				switch ($sky_d1){				        case 'sun.c2.st.png':						$sky_d1 = 'STORM';						break;				        case 'sun.c2.r1.png':						$sky_d1 = 'RAIN';						break;						case 'sun.c2.png':						$sky_d1 = 'PARTLY SUNNY';						break;						case 'sun.c4.png':						$sky_d1 = 'CLOUDY';						break;						case 'sun.png':						$sky_d1 = 'SUNNY';						$sky_id1 = '1';						break;						case 'sun.c3.png':						$sky_d1 = 'SUNNY';						break;						default: $sky_d1 = $sky_d1;					}					//Облачность послезавтра					switch ($sky_d2){					    case 'sun.c2.st.png':						$sky_d2 = 'STORM';						break;				        case 'sun.c2.r1.png':						$sky_d2 = 'RAIN';						break;						case 'sun.c2.png':						$sky_d2 = 'PARTLY SUNNY';						break;						case 'sun.c4.png':						$sky_d2 = 'CLOUDY';						break;						case 'sun.png':						$sky_d2 = 'SUNNY';						break;					    case 'sun.c3.png':						$sky_d2 = 'SUNNY';						break;						default: $sky_d2 = $sky_d2;					}      $data_send_d1 ="<station name='Rosa 1600'>\t <sky_today id='$sky_id'>$sky_today</sky_today> <temp_af>$t_temp_af</temp_af>	<time period='d1'>		<temperature value='$temp_d1_mon' />		<symbol name='$sky_d1' id='$sky_id' />		<windDirection code='$wind_dir_d1' />		<windSpeed mps='$wind_d1'/>	 </time>	 <time><temperature value='$temp_d1' /></time>	 <time/><time/>	 <time period='d2'>		<temperature value='$temp_d2_mon' />		<symbol name='$sky_d2' />		<windDirection code='$wind_dir_d2' />		<windSpeed mps='$wind_d2' />	 </time>	 <time><temperature value='$temp_d2' /></time> </station>";  	  	  		//echo  $data_send_d1;			       function sanitize($vars){ @$vars= htmlentities($vars); return @$vars; }         //готовим REST API (ну почти :))		if (isset($_GET['grab_gismeteo'])) {			$v1 = sanitize($_GET['grab_gismeteo']);			   if( $v1 == 'd1'){				if ($_SERVER['SERVER_PROTOCOL'] == 'HTTP/1.1'){					header('HTTP/1.1 200 OK');					header('Content-Type: application/xml; charset=utf-8');					print $data_send_d1; unset($data_send_d1);} else {					header('HTTP/1.0 200 OK');					header('Content-Type: application/xml; charset=utf-8');					print $data_send_d1;					unset($data_send_d1);					     } }			}?>